const nightIconList = {
    200: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    201: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    202: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    210: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    211: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    212: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    221: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    230: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    231: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    232: "./images/night-icons/ios11-weather-thunderstorm-icon.png",
    300: "./images/night-icons/ios11-weather-drizzle-icon.png",
    301: "./images/night-icons/ios11-weather-drizzle-icon.png",
    302: "./images/night-icons/ios11-weather-drizzle-icon.png",
    310: "./images/night-icons/ios11-weather-drizzle-icon.png",
    311: "./images/night-icons/ios11-weather-drizzle-icon.png",
    312: "./images/night-icons/ios11-weather-drizzle-icon.png",
    313: "./images/night-icons/ios11-weather-drizzle-icon.png",
    314: "./images/night-icons/ios11-weather-drizzle-icon.png",
    321: "./images/night-icons/ios11-weather-drizzle-icon.png",
    500: "./images/night-icons/ios11-weather-rain-icon.png",
    501: "./images/night-icons/ios11-weather-rain-icon.png",
    502: "./images/night-icons/ios11-weather-heavy-rain-icon.png",
    503: "./images/night-icons/ios11-weather-heavy-rain-icon.png",
    504: "./images/night-icons/ios11-weather-heavy-rain-icon.png",
    511: "./images/night-icons/ios11-weather-hail-icon.png",
    520: "./images/night-icons/ios11-weather-rain-icon.png",
    521: "./images/night-icons/ios11-weather-rain-icon.png",
    522: "./images/night-icons/ios11-weather-heavy-rain-icon.png",
    531: "./images/night-icons/ios11-weather-rain-icon.png",
    600: "./images/night-icons/ios11-weather-scattered-snow-icon.png",
    601: "./images/night-icons/ios11-weather-snow-icon.png",
    602: "./images/night-icons/ios11-weather-snow-sleet-icon.png",
    611: "./images/night-icons/ios11-weather-snow-sleet-icon.png",
    612: "./images/night-icons/ios11-weather-snow-sleet-icon.png",
    613: "./images/night-icons/ios11-weather-snow-sleet-icon.png",
    615: "./images/night-icons/ios11-weather-hail-icon.png",
    616: "./images/night-icons/ios11-weather-hail-icon.png",
    620: "./images/night-icons/ios11-weather-snow-icon.png",
    621: "./images/night-icons/ios11-weather-snow-icon.png",
    622: "./images/night-icons/ios11-weather-snow-sleet-icon.png",
    701: "./images/night-icons/ios11-weather-haze-icon.png",
    711: "./images/night-icons/ios11-weather-smoke-icon.png",
    721: "./images/night-icons/ios11-weather-haze-icon.png",
    731: "./images/night-icons/ios11-weather-dust-icon.png",
    741: "./images/night-icons/ios11-weather-fog-icon.png",
    751: "./images/night-icons/ios11-weather-dust-icon.png",
    761: "./images/night-icons/ios11-weather-dust-icon.png",
    762: "./images/no-report-icon.png",
    771: "./images/no-report-icon.png",
    781: "./images/night-icons/ios11-weather-tornado-icon.png",
    800: "./images/night-icons/ios11-weather-clear-night-icon.png",
    801: "./images/night-icons/ios11-weather-partly-cloudy-night-icon.png",
    802: "./images/night-icons/ios11-weather-partly-cloudy-night-icon.png",
    803: "./images/night-icons/ios11-weather-cloudy-icon.png",
    804: "./images/night-icons/ios11-weather-cloudy-icon.png",
};
const dayIconList = {
    200: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    201: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    202: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    210: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    211: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    212: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    221: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    230: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    231: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    232: "./images/day-icons/ios11-weather-thunderstorm-icon.png",
    300: "./images/day-icons/ios11-weather-drizzle-icon.png",
    301: "./images/day-icons/ios11-weather-drizzle-icon.png",
    302: "./images/day-icons/ios11-weather-drizzle-icon.png",
    310: "./images/day-icons/ios11-weather-drizzle-icon.png",
    311: "./images/day-icons/ios11-weather-drizzle-icon.png",
    312: "./images/day-icons/ios11-weather-drizzle-icon.png",
    313: "./images/day-icons/ios11-weather-drizzle-icon.png",
    314: "./images/day-icons/ios11-weather-drizzle-icon.png",
    321: "./images/day-icons/ios11-weather-drizzle-icon.png",
    500: "./images/day-icons/ios11-weather-rain-icon.png",
    501: "./images/day-icons/ios11-weather-rain-icon.png",
    502: "./images/day-icons/ios11-weather-heavy-rain-icon.png",
    503: "./images/day-icons/ios11-weather-heavy-rain-icon.png",
    504: "./images/day-icons/ios11-weather-heavy-rain-icon.png",
    511: "./images/day-icons/ios11-weather-hail-icon.png",
    520: "./images/day-icons/ios11-weather-rain-icon.png",
    521: "./images/day-icons/ios11-weather-rain-icon.png",
    522: "./images/day-icons/ios11-weather-heavy-rain-icon.png",
    531: "./images/day-icons/ios11-weather-rain-icon.png",
    600: "./images/day-icons/ios11-weather-scattered-snow-icon.png",
    601: "./images/day-icons/ios11-weather-snow-icon.png",
    602: "./images/day-icons/ios11-weather-snow-sleet-icon.png",
    611: "./images/day-icons/ios11-weather-snow-sleet-icon.png",
    612: "./images/day-icons/ios11-weather-snow-sleet-icon.png",
    613: "./images/day-icons/ios11-weather-snow-sleet-icon.png",
    615: "./images/day-icons/ios11-weather-hail-icon.png",
    616: "./images/day-icons/ios11-weather-hail-icon.png",
    620: "./images/day-icons/ios11-weather-snow-icon.png",
    621: "./images/day-icons/ios11-weather-snow-icon.png",
    622: "./images/day-icons/ios11-weather-snow-sleet-icon.png",
    701: "./images/day-icons/ios11-weather-haze-icon.png",
    711: "./images/day-icons/ios11-weather-smoke-icon.png",
    721: "./images/day-icons/ios11-weather-haze-icon.png",
    731: "./images/day-icons/ios11-weather-dust-icon.png",
    741: "./images/day-icons/ios11-weather-fog-icon.png",
    751: "./images/day-icons/ios11-weather-dust-icon.png",
    761: "./images/day-icons/ios11-weather-dust-icon.png",
    762: "./images/no-report-icon.png",
    771: "./images/no-report-icon.png",
    781: "./images/day-icons/ios11-weather-tornado-icon.png",
    800: "./images/day-icons/ios11-weather-sunny-icon.png",
    801: "./images/day-icons/ios11-weather-partly-sunny-icon.png",
    802: "./images/day-icons/ios11-weather-partly-sunny-icon.png",
    803: "./images/day-icons/ios11-weather-cloudy-icon.png",
    804: "./images/day-icons/ios11-weather-cloudy-icon.png",
};

$(document).ready(function() {
    setSessionID(sessionStorage.sessionID);
    runAPI();
});

//CRUD Operations

//Sets an ID called SessionID, which saves through page refreshes so data can be accessed from the database via an ID
function setSessionID(id) {
    if (typeof Storage !== "undefined") {
        sessionStorage.setItem("sessionID", id);
    } else {
        alert("Sorry, your browser does not support Web Storage...");
    }

    sessionID = sessionStorage.sessionID;
}

//Reads the data from an entry in the database given its ID and returns the data as a json object--or returns null if there's an error
function readLocationData(sessionID) {
    var locationData;

    $.ajax({
        method: "GET",
        url: "/read",
        data: {
            id: sessionID,
        },
        async: false,
        success: function(data) {
            locationData = {
                lat: data.lat,
                lon: data.lon,
                zipCode: data.zipCode,
                cityName: data.cityName,
            };
        },
        error: function(xhr, status, error) {
            var errorMessage = xhr.status + ": " + xhr.statusText;
            console.log("Error: " + errorMessage);
            locationData = null;
        },
    });

    return locationData;
}

//Updates an entry in the database given its ID and and the data to be updated
function updateLocationData(sessionID, lat, lon, zip, cityName) {
    $.ajax({
        method: "POST",
        url: "/update",
        data: {
            id: sessionID,
            lat: lat,
            lon: lon,
            zipCode: zip,
            cityName: cityName,
        },
        async: false,
        success: function(data) {
            console.log(`Data has been updated to: \n${data}`);
        },
        error: function(xhr, status, error) {
            var errorMessage = xhr.status + ": " + xhr.statusText;
            console.log("Error: " + errorMessage);
        },
    });
}

//Deletes an entry given its ID and logs what was deleted to the console
function deleteLocationData(sessionID) {
    $.ajax({
        method: "POST",
        url: "/delete",
        data: {
            id: sessionID,
        },
        success: function(data) {
            console.log(data);
        },
        error: function(xhr, status, error) {
            var errorMessage = xhr.status + ": " + xhr.statusText;
            console.log("Error: " + errorMessage);
        },
    });
}

function runAPI() {
    //Updated API call

    var location = readLocationData(sessionID);
    var lat = location.lat;
    var lon = location.lon;

    $.ajax({
        method: "GET",
        url: "/weather/coords/onecall",
        data: {
            lat: lat,
            lon: lon,
        },
        async: false,
        success: function(data) {
            populateWeather(data);
        },
        error: function(xhr, status, error) {
            var errorMessage = xhr.status + ": " + xhr.statusText;
            console.log("Error: " + errorMessage);
        },
    });
}

function populateWeather(obj) {
    var location = readLocationData(sessionID);
    for (var i = 0; i < 7; i++) {
        var dId = "#d" + (i + 1);
        var iId = "#icon" + (i + 1);
        var today = obj.daily[i];
        var nData = [];

        $(iId).attr(
            "src",
            changeIcon(today.weather[0].id, today.weather[0].icon.substring(2))
        );

        if (today.weather[0].main === "Clear") {
            $(dId).css("background", "#6691BB");
        } else if (today.weather[0].main === "Rain") {
            $(dId).css(
                "background",
                "linear-gradient(180deg, rgba(127, 123, 130, 1) 0%, #3c3c3c 100%"
            );
        } else if (today.weather[0].main === "Clouds") {
            $(dId).css("background", "#465367");
        } else if (today.weather[0].main === "Thunderstorm") {
            $(dId).css("background", "#78777F");
        } else if (today.weather[0].main === "Snow") {
            $(dId).css("background", "#759AAC");
        } else if (
            today.weather[0].main === "Fog" ||
            today.weather[0].main === "Mist"
        ) {
            $(dId).css("background", "#78777F");
        }
        nData.push(convertToDate(today.dt).toDateString().substring(0, 10));
        nData.push(location.cityName);
        nData.push(
            convertToDate(today.sunrise).toLocaleTimeString([], {
                hour: "numeric",
                minute: "numeric",
                hour12: true,
            })
        );
        nData.push(
            convertToDate(today.sunset).toLocaleTimeString([], {
                hour: "numeric",
                minute: "numeric",
                hour12: true,
            })
        );
        nData.push(Math.round(today.wind_speed) + " mph");
        nData.push(Math.round(today.temp.max) + "&deg;F");
        nData.push(Math.round(today.temp.min) + "&deg;F");
        nData.push(today.weather[0].description);
        nData.push("Rain: " + Math.round(today.pop * 100) + "%");
        nData.push("Humidity: " + today.humidity + "%");
        var aChild = $(dId)[0].children;
        var arrayTracker = 0;
        for (var n = 0; n < aChild.length; n++) {
            if (aChild[n].children.length > 0) {
                for (var k = 0; k < aChild[n].children.length; k++) {
                    if (aChild[n].children[k].tagName != "IMG") {
                        if (aChild[n].children[k].childNodes.length > 1) {
                            var len = aChild[n].children[k].childNodes.length - 1;
                            aChild[n].children[k].childNodes[len].nodeValue =
                                " " + nData[arrayTracker];
                        } else {
                            aChild[n].children[k].innerHTML = nData[arrayTracker];
                        }
                        arrayTracker++;
                    }
                }
            }
        }
    }
}

function convertToDate(n) {
    var time = n * 1000;
    return new Date(time);
}

function changeIcon(id, time) {
    if (time == "d") {
        return dayIconList[id];
    } else if (time == "n") {
        return nightIconList[id];
    }
}

$("form").submit(function(e) {
    e.preventDefault();
    var newZip = $("input").first().val();

    //Updated API call, calls to server which interacts with Open Weather API


    $.ajax({
        method: "GET",
        url: "/weather/zipCode",
        data: {
            zipCode: newZip,
        },
        async: false,
        success: function(data) {
            updateLocationData(sessionID, data.coord.lat, data.coord.lon, newZip, data.name);
            runAPI();
        },
        error: function(xhr, status, error) {
            var errorMessage = xhr.status + ": " + xhr.statusText;
            console.log("Error: " + errorMessage);
        },
    });
});